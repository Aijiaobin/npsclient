name: Update NPC Files

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  update-npc:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Set up tools
      run: |
        sudo apt-get update
        sudo apt-get install -y wget tar jq

    - name: Get latest version from djylb/nps
      run: |
        latest_version=$(curl --silent "https://api.github.com/repos/djylb/nps/releases/latest" | jq -r .tag_name)
        echo "Latest version: $latest_version"
        echo "LATEST_VERSION=$latest_version" >> $GITHUB_ENV

    - name: Check if update is needed
      run: |
        if [ -f app/src/main/jniLibs/version.txt ]; then
          current_version=$(cat app/src/main/jniLibs/version.txt)
          echo "Current version in version.txt: $current_version"
          if [ "$current_version" == "$LATEST_VERSION" ]; then
            echo "No update needed. The latest version is already installed."
            exit 0
          fi
        else
          echo "No version file found. Proceeding with the update."
        fi

    - name: Download NPC client binaries
      run: |
        wget https://github.com/djylb/nps/releases/latest/download/linux_arm_v7_client.tar.gz -O linux_arm_v7_client.tar.gz
        wget https://github.com/djylb/nps/releases/latest/download/android_arm64_client.tar.gz -O android_arm64_client.tar.gz
        wget https://github.com/djylb/nps/releases/latest/download/linux_amd64_client.tar.gz -O linux_amd64_client.tar.gz

    - name: Extract and rename NPC files
      run: |
        mkdir -p app/src/main/jniLibs/armeabi-v7a
        mkdir -p app/src/main/jniLibs/arm64-v8a
        mkdir -p app/src/main/jniLibs/x86_64

        tar -xzf linux_arm_v7_client.tar.gz -C app/src/main/jniLibs/armeabi-v7a npc
        tar -xzf android_arm64_client.tar.gz -C app/src/main/jniLibs/arm64-v8a npc
        tar -xzf linux_amd64_client.tar.gz -C app/src/main/jniLibs/x86_64 npc

        mv app/src/main/jniLibs/armeabi-v7a/npc app/src/main/jniLibs/armeabi-v7a/libnpc.so
        mv app/src/main/jniLibs/arm64-v8a/npc app/src/main/jniLibs/arm64-v8a/libnpc.so
        mv app/src/main/jniLibs/x86_64/npc app/src/main/jniLibs/x86_64/libnpc.so

    - name: Update version file
      run: |
        echo "$LATEST_VERSION" > app/src/main/jniLibs/version.txt

    - name: Commit and push changes
      run: |
        git config --global user.name "djylb"
        git config --global user.email "duan@d-jy.net"
        git add app/src/main/jniLibs/*
        git commit -m "Update NPC to $LATEST_VERSION"
        git push origin main
